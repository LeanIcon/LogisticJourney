name: Deploy Laravel to Azure VM (with host SQLite)

on:
  push:
    branches:
      - staging

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Docker Login to ACR
        uses: azure/docker-login@v2
        with:
          login-server: ${{ secrets.AZURE_URL }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.AZURE_URL }}/staging-admin:latest

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VM_SSH_KEY }}

      - name: Deploy to VM via SSH (mount host sqlite)
        env:
          ACR_URL: ${{ secrets.AZURE_URL }}
          ACR_USER: ${{ secrets.ACR_USERNAME }}
          ACR_PASS: ${{ secrets.ACR_PASSWORD }}
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} << 'EOF'
            set -euo pipefail

            echo "➤ Ensure host staging dirs"
            sudo mkdir -p /var/staging-storage /var/staging-cache /var/staging-db /var/staging-env
            sudo chown -R 33:33 /var/staging-storage /var/staging-cache /var/staging-db
            sudo chmod -R 775 /var/staging-storage /var/staging-cache /var/staging-db

            # ensure .env is present (this is mounted read-only into container)
            if [ ! -f /var/staging-env/.env ]; then
              echo "Warning: /var/staging-env/.env not found; copying example if present"
              if [ -f /var/www/.env.example ]; then
                sudo cp /var/www/.env.example /var/staging-env/.env
              else
                sudo bash -c 'echo "DB_CONNECTION=sqlite" > /var/staging-env/.env'
                sudo bash -c 'echo "DB_DATABASE=/var/www/database/database.sqlite" >> /var/staging-env/.env'
              fi
            fi

            # ensure sqlite file exists on host (create empty file if missing)
            if [ ! -f /var/staging-db/database.sqlite ]; then
              sudo touch /var/staging-db/database.sqlite
              sudo chown 33:33 /var/staging-db/database.sqlite
              sudo chmod 660 /var/staging-db/database.sqlite
              echo "Created empty sqlite file at /var/staging-db/database.sqlite"
            fi

            echo "➤ Logging into ACR..."
            echo "$ACR_PASS" | docker login $ACR_URL -u $ACR_USER --password-stdin

            echo "➤ Pulling latest image..."
            docker pull $ACR_URL/staging-admin:latest

            echo "➤ Stopping/removing old container..."
            docker stop staging-laravel || true
            docker rm staging-laravel || true

            echo "➤ Running container (mounting host sqlite)..."
            docker run -d \
              --name staging-laravel \
              --user 33:33 \
              -p 8081:8080 \
              --restart unless-stopped \
              -v /var/staging-storage:/var/www/storage \
              -v /var/staging-cache:/var/www/bootstrap/cache \
              -v /var/staging-env/.env:/var/www/.env:ro \
              -v /var/staging-db/database.sqlite:/var/www/database/database.sqlite:rw \
              --entrypoint /bin/sh \
              $ACR_URL/staging-admin:latest \
              -c "cd /var/www && php artisan config:cache || true && php artisan route:cache || true && php artisan view:cache || true && php artisan storage:link || true && exec php artisan serve --host=0.0.0.0 --port=8080"

            echo "➤ Waiting for startup..."
            sleep 20

            echo "➤ Status"
            docker ps | grep staging-laravel || true
            docker logs --tail 50 staging-laravel || true
          EOF
