name: Deploy Laravel to Azure VM (with host SQLite)

on:
  push:
    branches:
      - staging

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Docker Login to ACR
        uses: azure/docker-login@v2
        with:
          login-server: ${{ secrets.AZURE_URL }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.AZURE_URL }}/staging-admin:latest

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VM_SSH_KEY }}

      - name: Deploy to VM via SSH (mount host sqlite)
        env:
          ACR_URL: ${{ secrets.AZURE_URL }}
          ACR_USER: ${{ secrets.ACR_USERNAME }}
          ACR_PASS: ${{ secrets.ACR_PASSWORD }}
        run: |
          export ACR_URL=${{ secrets.AZURE_URL }}
          export ACR_USER=${{ secrets.ACR_USERNAME }}
          export ACR_PASS=${{ secrets.ACR_PASSWORD }}
          ssh -o StrictHostKeyChecking=no ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} "ACR_URL=$ACR_URL ACR_USER=$ACR_USER ACR_PASS=$ACR_PASS bash -s" << 'EOF'
            set -euo pipefail

            echo "➤ Ensure host staging dirs"
            # Use app-specific directory to avoid conflicts
            sudo mkdir -p /var/www/logistics/staging/{storage,cache,database,env}
            sudo chown -R 33:33 /var/www/logistics/staging
            sudo chmod -R 775 /var/www/logistics/staging

            # ensure .env is present (this is mounted read-only into container)
            if [ ! -f /var/www/logistics/staging/env/.env ]; then
              echo "Creating .env from repository .env.example..."
              cat > /var/www/logistics/staging/env/.env << 'ENVFILE'
              APP_NAME=Laravel
              APP_ENV=production
              APP_KEY=base64:RFM7JkSiIe1JMcnriou0ikQAZ+NO/rww9b8DqB1HLSI=
              APP_DEBUG=false
              APP_URL=http://52.186.10.124

              APP_LOCALE=en
              APP_FALLBACK_LOCALE=en
              APP_FAKER_LOCALE=en_US

              LOG_CHANNEL=stack
              LOG_STACK=single
              LOG_DEPRECATIONS_CHANNEL=null
              LOG_LEVEL=debug

              DB_CONNECTION=sqlite
              DB_DATABASE=/var/www/database/database.sqlite

              SESSION_DRIVER=database
              SESSION_LIFETIME=120
              SESSION_ENCRYPT=false
              SESSION_PATH=/
              SESSION_DOMAIN=null

              BROADCAST_CONNECTION=log
              FILESYSTEM_DISK=local
              QUEUE_CONNECTION=database

              CACHE_STORE=database
              ENVFILE
              sudo chown 33:33 /var/staging-env/.env
              sudo chmod 640 /var/staging-env/.env
              echo "Created production .env file"
            fi

            # ensure sqlite file exists on host (create empty file if missing)
            if [ ! -f /var/staging-db/database.sqlite ]; then
              sudo touch /var/staging-db/database.sqlite
              sudo chown 33:33 /var/staging-db/database.sqlite
              sudo chmod 660 /var/staging-db/database.sqlite
              echo "Created empty sqlite file at /var/staging-db/database.sqlite"
            fi

            echo "➤ Logging into ACR..."
            echo "$ACR_PASS" | docker login $ACR_URL -u $ACR_USER --password-stdin

            echo "➤ Pulling latest image..."
            docker pull $ACR_URL/staging-admin:latest

            echo "➤ Stopping/removing old container..."
            docker stop staging-laravel || true
            docker rm staging-laravel || true

            echo "➤ Running container (mounting host sqlite)..."
            docker run -d \
              --name staging-laravel \
              --user 33:33 \
              -p 8084:8080 \
              --restart unless-stopped \
              -v /var/www/logistics/staging/storage:/var/www/storage \
              -v /var/www/logistics/staging/cache:/var/www/bootstrap/cache \
              -v /var/www/logistics/staging/env/.env:/var/www/.env:ro \
              -v /var/www/logistics/staging/database/database.sqlite:/var/www/database/database.sqlite:rw \
              --entrypoint /bin/sh \
              $ACR_URL/staging-admin:latest \
              -c "cd /var/www && php artisan config:cache || true && php artisan route:cache || true && php artisan view:cache || true && php artisan storage:link || true && exec php artisan serve --host=0.0.0.0 --port=8080"

            echo "➤ Waiting for startup..."
            sleep 20

            echo "➤ Status"
            docker ps | grep staging-laravel || true
            docker logs --tail 50 staging-laravel || true
          EOF
