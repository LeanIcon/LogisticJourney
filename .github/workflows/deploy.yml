name: Deploy Laravel to VPS

on:
  push:
    branches:
      - staging

concurrency:
  group: logisticjourney-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e

            APP_DIR="${{ secrets.REMOTE_DIR }}"

            echo "➤ SSH preflight checks"
            command -v git >/dev/null || { echo "❌ git missing"; exit 1; }
            command -v php >/dev/null || { echo "❌ php missing"; exit 1; }
            command -v composer >/dev/null || { echo "❌ composer missing"; exit 1; }

            cd "$APP_DIR"

            # Ensure Git trusts this directory (Git 2.35+)
            git config --global --add safe.directory "$APP_DIR"

            LOCK_FILE="$APP_DIR/.deploy.lock"
            PREV_SHA_FILE="$APP_DIR/.deploy.prev"

            if [ -f "$LOCK_FILE" ]; then
              echo "❌ Deploy already in progress. Exiting."
              exit 1
            fi

            echo $$ > "$LOCK_FILE"

            rollback() {
              echo "⚠️ Deploy failed — rolling back"
              if [ -f "$PREV_SHA_FILE" ]; then
                git reset --hard "$(cat $PREV_SHA_FILE)" || true
                php artisan optimize:clear || true
              fi
              rm -f "$LOCK_FILE"
            }

            trap rollback ERR

            echo "➤ Recording current revision for rollback"
            git rev-parse HEAD > "$PREV_SHA_FILE" || true

            echo "➤ Pulling latest code"
            git fetch origin staging
            git reset --hard origin/staging

            echo "➤ Ensuring scripts are executable"
            chmod +x setup.sh deploy.sh || true
            chmod +x scripts/*.sh || true

            echo "➤ Running setup (verify-first, non-destructive)"
            bash setup.sh

            echo "➤ Running deploy (zero-downtime)"
            bash deploy.sh

            rm -f "$LOCK_FILE"

            echo "✅ Deployment completed successfully"
